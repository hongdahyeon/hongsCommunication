<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default}">

<th:block layout:fragment="content">
    <th:block th:replace="~{fragments/title :: title('게시판 관리')}"></th:block>
    <div style="text-align: right;">
        <button type="button" class="btn btn-primary" id="add-board">게시판 추가하기</button>
    </div>
    <div id="table"></div>

    <!-- s: add Modal -->
    <div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModallLabel" aria-hidden="true" data-bs-keyboard="false" data-bs-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h4>게시판 추가하기</h4>
                </div>
                <div class="modal-body">
                    <form id="addModal-form" class="needs-validation" novalidate>
                        <div class="col-md-12 col-12">
                            <div class="mb-1 margin-10">
                                <label for="addModal-boardName">게시판명<span class="text-primary ms-50">*</span></label>
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" id="addModal-boardName" name="boardName" required>
                                </div>
                                <div class="invalid-feedback">게시판명을 입력해주세요.</div>
                            </div>
                        </div>

                        <div class="col-md-12 col-12">
                            <div class="mb-1 margin-10">
                                <label for="addModal-boardTypeCd">게시판 유형<span class="text-primary ms-50">*</span></label>
                                <select class="form-select" name="boardTypeCd" id="addModal-boardTypeCd" required>
                                    <th:block th:each="board, boardStat: ${boardType}">
                                        <option th:selected="${boardStat?.first}" th:value="${board?.codeVal}" th:text="${board?.codeName}"></option>
                                    </th:block>
                                </select>
                                <div class="invalid-feedback">게시판 유형을 입력해주세요.</div>
                            </div>
                        </div>

                        <div class="col-md-12 col-12" style="margin-top: 10px;">
                            <div class="mb-1 margin-10">
                                <label>댓글사용여부<span class="text-primary ms-50">*</span></label>
                                <div class="mb-1 margin-10">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="commentYn" id="addModal-commentYn-Y" value="Y" required checked>
                                        <label class="form-check-label" for="addModal-commentYn-Y">사용</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="commentYn" id="addModal-commentYn-N" value="N" required>
                                        <label class="form-check-label" for="addModal-commentYn-N">미사용</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-12 col-12" style="margin-top: 10px;">
                            <div class="mb-1 margin-10">
                                <label>첨부파일 사용여부<span class="text-primary ms-50">*</span></label>
                                <div class="mb-1 margin-10">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="fileAtchYn" id="addModal-fileAtchYn-Y" value="Y" required checked>
                                        <label class="form-check-label" for="addModal-fileAtchYn-Y">사용</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="fileAtchYn" id="addModal-fileAtchYn-N" value="N" required>
                                        <label class="form-check-label" for="addModal-fileAtchYn-N">미사용</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-12 col-12" style="margin-top: 10px;">
                            <div class="mb-1 margin-10">
                                <label>사용여부<span class="text-primary ms-50">*</span></label>
                                <div class="mb-1 margin-10">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="useYn" id="addModal-useYn-Y" value="Y" required checked>
                                        <label class="form-check-label" for="addModal-useYn-Y">사용</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="useYn" id="addModal-useYn-N" value="N" required>
                                        <label class="form-check-label" for="addModal-useYn-N">미사용</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 10px" class="text-end">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
                            <button type="button" class="btn btn-outline-primary" id="addModal-btn">추가하기</button>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- e: add Modal -->

    <!-- s: edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true" data-bs-keyboard="false" data-bs-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h4>게시판 수정하기</h4>
                </div>
                <div class="modal-body">
                    <form id="editModal-form" class="needs-validation" novalidate>
                        <input type="hidden" name="hongBoardTypeUid" id="editModal-hongBoardTypeUid" />
                        <div class="col-md-12 col-12">
                            <div class="mb-1 margin-10">
                                <label for="addModal-boardName">게시판명<span class="text-primary ms-50">*</span></label>
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" id="editModal-boardName" name="boardName" required>
                                </div>
                                <div class="invalid-feedback">게시판명을 입력해주세요.</div>
                            </div>
                        </div>

                        <div class="col-md-12 col-12">
                            <div class="mb-1 margin-10">
                                <label for="editModal-boardTypeCd">게시판 유형<span class="text-primary ms-50">*</span></label>
                                <select class="form-select" name="boardTypeCd" id="editModal-boardTypeCd" required>
                                    <th:block th:each="board, boardStat: ${boardType}">
                                        <option th:selected="${boardStat?.first}" th:value="${board?.codeVal}" th:text="${board?.codeName}"></option>
                                    </th:block>
                                </select>
                                <div class="invalid-feedback">게시판 유형을 입력해주세요.</div>
                            </div>
                        </div>

                        <div class="col-md-12 col-12" style="margin-top: 10px;">
                            <div class="mb-1 margin-10">
                                <label>댓글사용여부<span class="text-primary ms-50">*</span></label>
                                <div class="mb-1 margin-10">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="commentYn" id="editModal-commentYn-Y" value="Y" required checked>
                                        <label class="form-check-label" for="editModal-commentYn-Y">사용</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="commentYn" id="editModal-commentYn-N" value="N" required>
                                        <label class="form-check-label" for="editModal-commentYn-N">미사용</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-12 col-12" style="margin-top: 10px;">
                            <div class="mb-1 margin-10">
                                <label>첨부파일 사용여부<span class="text-primary ms-50">*</span></label>
                                <div class="mb-1 margin-10">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="fileAtchYn" id="editModal-fileAtchYn-Y" value="Y" required checked>
                                        <label class="form-check-label" for="editModal-fileAtchYn-Y">사용</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="fileAtchYn" id="editModal-fileAtchYn-N" value="N" required>
                                        <label class="form-check-label" for="editModal-fileAtchYn-N">미사용</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-12 col-12" style="margin-top: 10px;">
                            <div class="mb-1 margin-10">
                                <label>사용여부<span class="text-primary ms-50">*</span></label>
                                <div class="mb-1 margin-10">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="useYn" id="editModal-useYn-Y" value="Y" required checked>
                                        <label class="form-check-label" for="editModal-useYn-Y">사용</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="useYn" id="editModal-useYn-N" value="N" required>
                                        <label class="form-check-label" for="editModal-useYn-N">미사용</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 10px" class="text-end">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
                            <button type="button" class="btn btn-outline-primary" id="del-board">게시판 삭제하기</button>
                            <button type="button" class="btn btn-primary" id="editModal-btn">수정하기</button>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- e: edit Modal -->

</th:block>

<th:block layout:fragment="script">
    <script>
        let table = new Table("table")

        $(document).ready(function() {
            table
                .get('/api/admin/board/type/list.json')
                .usePagination()
                .headerCenter()
                .add(new Column("index").title("#").width(5).center())
                .add(new Column("boardTypeName").title("게시판 유형").width(10).left())
                .add(new Column("boardName").title("게시판 이름").width(10).left())
                .add(new Column("commentYnStr").title("댓글 <br> 사용여부").width(10).center().formatter(function (cell) {
                    const cellData = cell.getData()
                    return (cellData['commentYn'] === 'Y') ?
                        `<a href="#" onclick="changeYn(this)" data-num="${cellData['hongBoardTypeUid']}" data-yn="commentYn" data-now="${cellData['commentYn']}" style="color: green">${cellData['commentYnStr']}</a>`
                        : `<a href="#" onclick="changeYn(this)" data-num="${cellData['hongBoardTypeUid']}" data-yn="commentYn" data-now="${cellData['commentYn']}" style="color: red">${cellData['commentYnStr']}</a>`
                }))
                .add(new Column("fileAtchYnStr").title("첨부파일 <br> 사용여부").width(10).center().formatter(function (cell) {
                    const cellData = cell.getData()
                    return (cellData['fileAtchYn'] === 'Y') ?
                        `<a href="#" onclick="changeYn(this)" data-num="${cellData['hongBoardTypeUid']}" data-yn="fileAtchYn" data-now="${cellData['fileAtchYn']}" style="color: green">${cellData['fileAtchYnStr']}</a>`
                        : `<a href="#" onclick="changeYn(this)" data-num="${cellData['hongBoardTypeUid']}" data-yn="fileAtchYn" data-now="${cellData['fileAtchYn']}" style="color: red">${cellData['fileAtchYnStr']}</a>`
                }))
                .add(new Column("useYnStr").title("게시판 <br> 사용여부").width(10).center().formatter(function (cell) {
                    const cellData = cell.getData()
                    return (cellData['useYn'] === 'Y') ?
                        `<a href="#" onclick="changeYn(this)" data-num="${cellData['hongBoardTypeUid']}" data-yn="useYn" data-now="${cellData['useYn']}" style="color: green">${cellData['useYnStr']}</a>`
                        : `<a href="#" onclick="changeYn(this)" data-num="${cellData['hongBoardTypeUid']}" data-yn="useYn" data-now="${cellData['useYn']}" style="color: red">${cellData['useYnStr']}</a>`
                }))
                .add(new Column("regName").title("등록자").width(10).center())
                .add(new Column("regDt").title("등록일").width(10).center())
                .add(new Column("hongCodeUid").title("수정하기").width(10).center().formatter(function (cell) {
                    return `<button type="button" class="btn btn-sm btn-outline-primary" data-num="${cell.getData()['hongBoardTypeUid']}" onclick="changeBoardType(this)">게시판 수정</button>`
                }))
                .add(new Column("hongCodeUid").title("게시글 관리하기").width(10).center().formatter(function (cell) {
                    const cellData = cell.getData()
                    const disabled = (cellData['useYn'] === 'N') ? "disabled" : ''
                    return `<button type="button" class="btn btn-sm btn-outline-primary" data-type="${cellData['boardCd']}" data-num="${cellData['hongBoardTypeUid']}" ${disabled} onclick="gotoReport(this)">게시글 관리하기</button>`
                }))
                .init()

            /* 게시판 유형 추가 모달 띄우기 */
            $("#add-board").on('click', () => {
                $("#addModal").modal('show')
            })

            /* 게시판 유형 추가하기 */
            $("#addModal-btn").on('click', (e) => {
                e.preventDefault()
                const form = document.getElementById("addModal-form")
                if (form.checkValidity() === false) form.classList.add("was-validated")
                else {
                    FormDataToObj.getParameter("addModal-form").then(obj => {
                        Http.post('/api/admin/board/type/insert.json', obj).then(res => {
                            if(res['httpStatus'] === 201) {
                                Util.alert("게시판 유형이 등록되었습니다.").then(() => {
                                    table.submit()
                                    $("#addModal").modal('hide')
                                })
                            } else if(res['httpStatus'] === 400) Util.alert("게시판 유형 등록에 실패했습니다.")
                        })
                    });
                }
            })

            /* 게시판 유형 수정하기 */
            $("#editModal-btn").on('click', (e) => {
                e.preventDefault()
                const form = document.getElementById("editModal-form")
                if (form.checkValidity() === false) form.classList.add("was-validated")
                else {
                    FormDataToObj.getParameter("editModal-form").then(obj => {
                        Http.put('/api/admin/board/type/update.json', obj).then((res) => {
                            if(res['httpStatus'] === 200) {
                                Util.alert("게시판 유형이 수정되었습니다.").then(() => {
                                    table.submit()
                                    $("#editModal").modal('hide')
                                })
                            }  else if(res['httpStatus'] === 400) Util.alert("게시판 유형 등록에 실패했습니다.")
                        })
                    });
                }
            })

            /* 게시판 유형 삭제하기 */
            $("#del-board").on('click', () => {
                const hongBoardTypeUid = $("#editModal-hongBoardTypeUid").val()
                Http.delete(`/api/admin/board/type/delete.json?hongBoardTypeUid=${hongBoardTypeUid}`).then((res) => {
                    if(res['httpStatus'] === 200) {
                        Util.alert("게시판 유형이 삭제되었습니다.").then(() => {
                            table.submit()
                            $("#editModal").modal('hide')
                        })
                    }  else if(res['httpStatus'] === 400) Util.alert("게시판 유형 삭제에 실패했습니다.")
                })
            })

            /* 게시판 유형 등록 모달 닫힐때 */
            $("#addModal").on('hidden.bs.modal', (e) => {
                e.preventDefault();
                $("#addModal-boardName").val('')
                $("#addModal-useYn-Y").prop('checked', true)
                $("#addModal-commentYn-Y").prop('checked', true)
                $("#addModal-fileAtchYn-Y").prop('checked', true)
                document.getElementById("addModal-form").classList.remove('was-validated');
            });

            /* 게시판 유형 수정 모달 닫힐때 */
            $("#editModal").on('hidden.bs.modal', (e) => {
                e.preventDefault();
                $("#editModal-hongBoardTypeUid").val(0)
                $("#editModal-boardName").val('')
                $("#editModal-useYn-Y").prop('checked', true)
                $("#editModal-commentYn-Y").prop('checked', true)
                $("#editModal-fileAtchYn-Y").prop('checked', true)
                document.getElementById("editModal-form").classList.remove('was-validated');
            });
        })

        function changeYn(This) {
            const hongBoardTypeUid = This.getAttribute("data-num")
            const yn = This.getAttribute("data-yn")
            const now = This.getAttribute("data-now")
            const change = (now === 'Y') ? 'N' : 'Y'
            const message = (yn === 'commentYn') ? '댓글 사용여부' : (yn === 'fileAtchYn') ? '첨부파일 사용여부' : '사용여부'
            Util.confirm(`해당 게시판 유형의 ${message}를 변경하시겠습니까?`).then((isOk) => {
                if(isOk) {
                    Http.put('/api/admin/board/type/ynUpdate.json', {uid: hongBoardTypeUid, type: yn, ynValue: change}).then((res) => {
                        if(res['httpStatus'] === 200) {
                            Util.alert(`해당 게시판 유형의 ${message}가 변경되었습니다.`).then(() => {
                                table.submit()
                            })
                        }  else if(res['httpStatus'] === 400) Util.alert(`해당 게시판 유형의 ${message}의 변경에 실패했습니다.`)
                    })
                }
            })
        }

        function gotoReport(This) {
            const hongBoardTypeUid = This.getAttribute("data-num")
            const boardCd = This.getAttribute("data-type")
            window.location.href = `/admin/board/report/${boardCd}?uid=${hongBoardTypeUid}`
        }

        function changeBoardType(This) {
            const hongBoardTypeUid = This.getAttribute("data-num")
            Http.get(`/api/admin/board/type/view.json?hongBoardTypeUid=${hongBoardTypeUid}`).then(res => {
                if(res['httpStatus'] === 200) {
                    const data = res.message
                    $("#editModal-hongBoardTypeUid").val(data['hongBoardTypeUid'])
                    $('#editModal-boardTypeCd').val(data['boardTypeCd'])
                    $("#editModal-boardName").val(data['boardName'])
                    $(`#editModal-useYn-${data['useYn']}`).prop('checked', true)
                    $(`#editModal-commentYn-${data['commentYn']}`).prop('checked', true)
                    $(`#editModal-fileAtchYn-${data['fileAtchYn']}`).prop('checked', true)
                    $("#editModal").modal('show')
                }
            })
        }
    </script>
</th:block>

</html>